<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì¸í”„ë° ì˜í™” ì •ë³´ ì‚¬ì´íŠ¸</title>
  <link rel="stylesheet" href="main.css">
</head>
<body>
  <div class="container">
    <!-- í—¤ë” + ë„¤ë¹„ê²Œì´ì…˜ -->
    <header>
      <h1 class="site-title">ì¸í”„ë° ì˜í™” ì •ë³´ ì‚¬ì´íŠ¸ì…ë‹ˆë‹¤.</h1>
      <nav class="nav-bar">
        <a href="index.html" class="active">ë©”ì¸í˜ì´ì§€</a>
        <a href="login.html">ë¡œê·¸ì¸</a>
        <a href="signup.html">íšŒì›ê°€ì…</a>
      </nav>
    </header>
    <hr class="divider">

    <!-- ì˜í™” ìƒì„¸ ì •ë³´ ì¹´ë“œ -->
    <main id="movieDetail" class="detail-container">
      <p>ë¡œë”© ì¤‘...</p>
    </main>

    <!-- í›„ê¸° ì„¹ì…˜ -->
    <section class="comments-section">
      <h3>ğŸï¸ ì˜í™” í›„ê¸°</h3>
      <ul id="commentList" class="comment-list">
        <li>ë¡œë”© ì¤‘...</li>
      </ul>
      <form id="commentForm">
        <textarea id="commentText" rows="3" placeholder="í›„ê¸°ë¥¼ ì‘ì„±í•˜ì„¸ìš”" required></textarea>
        <button type="submit">ëŒ“ê¸€ ë‚¨ê¸°ê¸°</button>
      </form>
    </section>

    <div class="button-group">
      <a href="index.html"><button>â† ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button></a>
    </div>
  </div>

  <script>
  (function() {
    // 1) ì¿¼ë¦¬ìŠ¤íŠ¸ë§ì—ì„œ movieId íŒŒì‹±
    const params  = new URLSearchParams(window.location.search);
    const movieId = params.get('id');

    const detailEl = document.getElementById('movieDetail');
    if (!movieId || isNaN(movieId)) {
      detailEl.innerHTML = '<p>ì˜ëª»ëœ ì˜í™” IDì…ë‹ˆë‹¤.</p>';
      return;
    }
    console.log('ğŸ” movieId =', movieId);

    // 2) í¬ìŠ¤í„° URL ì²˜ë¦¬ í•¨ìˆ˜
    const getPosterURL = path =>
      path?.startsWith('http')
        ? path
        : 'https://image.tmdb.org/t/p/w300' + path;

    // 3) ì˜í™” ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
    fetch(`/api/movies/${movieId}`)
      .then(res => {
        if (!res.ok) throw new Error(`Status ${res.status}`);
        return res.json();
      })
      .then(movie => {
        detailEl.innerHTML = `
          <div class="detail-poster">
            <img src="${getPosterURL(movie.img)}"
                alt="${movie.movie_title}">
          </div>
          <div class="detail-info">
            <p>ì˜í™” id: ${movie.movie_id}</p>
            <h2>ğŸ¥ ${movie.movie_title}</h2>
            <p><span class="label">ğŸ¬ ê°œë´‰ì¼:</span> ${movie.release_date}</p>
            <p><span class="label">â˜… í‰ì :</span> ${movie.rate}</p>
            <p><span class="label">ğŸ“‹ ì¤„ê±°ë¦¬:</span> ${movie.overview}</p>
          </div>
        `;
      })
      .catch(err => {
        console.error(err);
        detailEl.innerHTML = '<p>ì˜í™” ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>';
      });

    // 4) í›„ê¸°(ëŒ“ê¸€) ë¶ˆëŸ¬ì˜¤ê¸°
    const commentList = document.getElementById('commentList');
    function loadComments() {
      fetch(`/api/movies/${movieId}/comments`)
        .then(res => {
          if (!res.ok) throw new Error(`Status ${res.status}`);
          return res.json();
        })
        .then(comments => {
          commentList.innerHTML = comments.length
            ? comments.map(c => `
                <li data-id="${c.review_id}">
                  <p>${c.review_content}</p>
                </li>
              `).join('')
            : '<li>ì•„ì§ ë‚¨ì€ í›„ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.</li>';
        })
        .catch(err => {
          console.error('ëŒ“ê¸€ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', err);
          commentList.innerHTML = '<li>ëŒ“ê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</li>';
        });
    }
    loadComments();

    // ìƒˆ ëŒ“ê¸€ ë“±ë¡
    document.getElementById('commentForm')
      .addEventListener('submit', e=>{
        e.preventDefault();
        const text = document.getElementById('commentText').value.trim();
        if (!text) return;
        fetch(`/api/movies/${movieId}/comments`, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ text })
        })
        .then(res => {
          if (!res.ok) throw new Error(`Status ${res.status}`);
          document.getElementById('commentText').value = '';
          return res.json();
        })
        .then(_ => loadComments())
        .catch(err=>{
          console.error('ëŒ“ê¸€ ì €ì¥ ì‹¤íŒ¨:', err);
          alert('ëŒ“ê¸€ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        });
      });
  })();
  </script>
</body>
</html>
